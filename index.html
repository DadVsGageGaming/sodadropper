<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Soda Dropper!</title>
  <style>
    body { background: #111; margin: 0; color: #fff; font-family: sans-serif; overflow: hidden; }
    #container { display: flex; flex-direction: row; align-items: flex-start; }
    #gameCanvas { background: #242424; border-radius: 20px; margin: 20px; }
    #sidebar { margin-top: 20px; margin-left: 10px; }
    .score, .highscore, .level { font-size: 1.3em; margin: 8px 0; }
    .lineup { display: flex; margin: 8px 0; }
    .lineup img { width: 32px; height: 32px; margin-right: 4px; border-radius: 8px; background: #222; }
    .btn { padding: 8px 20px; border-radius: 8px; border: none; font-size: 1em; background: #f60; color: #fff; cursor: pointer; margin: 8px 0; }
    .hidden { display: none; }
    #gameOverMessage { font-size: 2em; margin-top: 30px; color: #ff3; text-shadow: 1px 1px 10px #f30; }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="gameCanvas" width="480" height="600"></canvas>
    <div id="sidebar">
      <div class="score">Score: <span id="score">0</span></div>
      <div class="highscore">High Score: <span id="highscore">0</span></div>
      <div class="level">Level: <span id="level">1</span></div>
      <div class="lineup" id="lineup"></div>
      <button class="btn" id="resetBtn">Reset</button>
      <div id="gameOverMessage" class="hidden"></div>
    </div>
  </div>
  <audio id="bgm" src="https://cdn.pixabay.com/audio/2023/03/24/audio_126b0b5c8d.mp3" loop></audio>
  <audio id="mergeSfx" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b9c2f5d.mp3"></audio>
  <audio id="dropSfx" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12b0e9a7d3.mp3"></audio>
  <audio id="orangeMountainSfx" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b9c2f5d.mp3"></audio>
  <audio id="fizzSfx" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12c3f3e3c8.mp3"></audio>
  <audio id="gameoverSfx" src="https://cdn.pixabay.com/audio/2022/10/16/audio_125f2d8f4e.mp3"></audio>

  <script>
    // ===== Soda Data =====
    const sodas = [
      // Level 1 Sodas (Normal Mode)
      { name: "Shasta",        img: "https://i.imgur.com/2iF7k8u.png" },
      { name: "Dr. Thunder",   img: "https://i.imgur.com/0wY6V9g.png" },
      { name: "Faygo",         img: "https://i.imgur.com/dRhB3tO.png" },
      { name: "Mug Root Beer", img: "https://i.imgur.com/1w6o8wZ.png" },
      { name: "RC Cola",       img: "https://i.imgur.com/2wWzqkF.png" },
      { name: "Barq’s",        img: "https://i.imgur.com/7s2A1qd.png" },
      { name: "Sprite",        img: "https://i.imgur.com/N6nKfA9.png" },
      { name: "Mountain Dew",  img: "https://i.imgur.com/Uf3aQwW.png" },
      { name: "Fanta",         img: "https://i.imgur.com/1SdVd3s.png" },
      { name: "Dr. Pepper",    img: "https://i.imgur.com/Wx7n8eH.png" },
      { name: "Coca-Cola",     img: "https://i.imgur.com/bXWqz9e.png" },
      { name: "Pepsi",         img: "https://i.imgur.com/c5N6RZk.png" },
      // Secret unlock
      { name: "Orange Mountain", img: "https://i.imgur.com/Zf2y3TG.png", secret: true },
      // Level 2 Sodas (Secret Mode)
      { name: "LaCroix",      img: "https://i.imgur.com/Im9ATk8.png", secret: true },
      { name: "Red Bull",     img: "https://i.imgur.com/9fA1R0u.png", secret: true },
      { name: "Monster",      img: "https://i.imgur.com/3n2zJ5O.png", secret: true },
      { name: "Rockstar",     img: "https://i.imgur.com/eeEw3vE.png", secret: true },
      { name: "7Up",          img: "https://i.imgur.com/4D1F6A9.png", secret: true },
      { name: "Canada Dry",   img: "https://i.imgur.com/ci3hVqh.png", secret: true },
      { name: "Pepsi Zero",   img: "https://i.imgur.com/HQ8DRYp.png", secret: true },
      { name: "Diet Coke",    img: "https://i.imgur.com/9e4n0W9.png", secret: true },
      { name: "Coke Vanilla", img: "https://i.imgur.com/9U6kG7u.png", secret: true },
      { name: "Big Cola",     img: "https://i.imgur.com/n7jXWmM.png", secret: true },
      { name: "Fanta Exotic", img: "https://i.imgur.com/2R2yW4V.png", secret: true },
      { name: "Coke Classic", img: "https://i.imgur.com/F8J6e6J.png", secret: true }
    ];
    const LEVEL_1_LEN = 12;
    const ORANGE_MOUNTAIN_IDX = 12;
    const LEVEL_2_START = 13;

    // ====== Game Constants ======
    const CANVAS_W = 480, CANVAS_H = 600;
    const BOX_X = 40, BOX_Y = 60, BOX_W = 400, BOX_H = 480;
    const GRAVITY = 0.4;
    const FRICTION = 0.995;
    const RADIUS_TABLE = [22,24,25,27,29,32,35,39,44,50,54,58,26,23,24,25,28,29,32,36,44,50,54,58]; // px
    const SPAWN_Y = BOX_Y + 45;
    const DROP_SPEED = 10; // px/frame
    const SPAWN_INTERVAL = 380; // ms delay before next soda
    const FIZZ_COLOR = "#fff86e";
    const FIZZ_PARTICLES = 60;

    // ====== Game State ======
    let sodasInPlay = [];
    let currentSoda = null;
    let currentSodaX = CANVAS_W/2;
    let mouseX = CANVAS_W/2;
    let readyToDrop = true;
    let score = 0;
    let highscore = 0;
    let level = 1;
    let unlockedOrangeMountain = false;
    let orangeMountainChance = 0;
    let secretMode = false;
    let fizzyParticles = [];
    let gameOver = false;
    let gameOverText = "";
    let canDrop = true;
    let comboFizz = false;

    // ====== DOM Elements ======
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreSpan = document.getElementById('score');
    const highscoreSpan = document.getElementById('highscore');
    const levelSpan = document.getElementById('level');
    const lineupDiv = document.getElementById('lineup');
    const resetBtn = document.getElementById('resetBtn');
    const gameOverDiv = document.getElementById('gameOverMessage');

    // ====== Audio ======
    const bgm = document.getElementById('bgm');
    const mergeSfx = document.getElementById('mergeSfx');
    const dropSfx = document.getElementById('dropSfx');
    const orangeMountainSfx = document.getElementById('orangeMountainSfx');
    const fizzSfx = document.getElementById('fizzSfx');
    const gameoverSfx = document.getElementById('gameoverSfx');
    let bgmStarted = false;

    // ====== Utility ======
    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

    // ====== Soda Class ======
    class Soda {
      constructor(level, x, y, vx=0, vy=0, isOrangeMountain=false) {
        this.level = level;
        this.x = x;
        this.y = y;
        this.vx = vx;
        this.vy = vy;
        this.radius = RADIUS_TABLE[level];
        this.img = new Image();
        this.img.src = sodas[level].img;
        this.merging = false;
        this.mergedAt = 0;
        this.isOrangeMountain = isOrangeMountain;
        this.fizzing = false;
      }
      draw(ctx) {
        // Fizz highlight if merging
        if(this.merging) {
          ctx.save();
          ctx.globalAlpha = 0.7;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius+8, 0, Math.PI*2);
          ctx.fillStyle = FIZZ_COLOR;
          ctx.fill();
          ctx.restore();
        }
        ctx.save();
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
        ctx.clip();
        ctx.drawImage(this.img, this.x-this.radius, this.y-this.radius, this.radius*2, this.radius*2);
        ctx.restore();
        // Draw soda name
        // ctx.font = "bold 11px Arial"; ctx.fillStyle = "#fff";
        // ctx.fillText(sodas[this.level].name, this.x-this.radius, this.y+this.radius+10);
      }
    }

    // ====== Fizz Animation ======
    function spawnFizz(x, y, color, count) {
      for (let i=0; i<count; ++i) {
        let angle = Math.random()*Math.PI*2;
        let speed = 3+Math.random()*4;
        fizzyParticles.push({
          x, y,
          vx: Math.cos(angle)*speed,
          vy: Math.sin(angle)*speed,
          life: 36+Math.random()*32,
          color
        });
      }
    }

    function updateFizz() {
      fizzyParticles = fizzyParticles.filter(p => p.life>0);
      fizzyParticles.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.vy += 0.15;
        p.life -= 1;
      });
    }
    function drawFizz() {
      fizzyParticles.forEach(p=>{
        ctx.save();
        ctx.globalAlpha = Math.max(0, p.life/50);
        ctx.beginPath();
        ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
        ctx.fillStyle = p.color;
        ctx.fill();
        ctx.restore();
      });
    }

    // ====== Game Loop ======
    function gameLoop() {
      ctx.clearRect(0,0,CANVAS_W,CANVAS_H);
      // Draw box
      ctx.save();
      ctx.fillStyle = "#181818";
      ctx.fillRect(BOX_X, BOX_Y, BOX_W, BOX_H);
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 4;
      ctx.strokeRect(BOX_X, BOX_Y, BOX_W, BOX_H);
      ctx.restore();

      // Draw sodas in play
      sodasInPlay.forEach(soda => soda.draw(ctx));

      // Draw current soda preview
      if(currentSoda && !gameOver) {
        ctx.save();
        ctx.globalAlpha = 0.82;
        ctx.beginPath();
        ctx.arc(currentSodaX, SPAWN_Y, currentSoda.radius, 0, Math.PI*2);
        ctx.clip();
        ctx.drawImage(currentSoda.img, currentSodaX-currentSoda.radius, SPAWN_Y-currentSoda.radius, currentSoda.radius*2, currentSoda.radius*2);
        ctx.restore();
      }

      // Fizz particles
      updateFizz();
      drawFizz();

      // Draw top bar for next-up
      ctx.save();
      ctx.fillStyle = "#282828";
      ctx.fillRect(BOX_X, 10, BOX_W, 38);
      ctx.font = "bold 19px Arial";
      ctx.fillStyle = "#fff";
      ctx.fillText("Soda Lineup →", BOX_X+10, 34);
      ctx.restore();

      // Game Over overlay
      if(gameOver) {
        ctx.save();
        ctx.globalAlpha = 0.7;
        ctx.fillStyle = "#000";
        ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
        ctx.globalAlpha = 1;
        ctx.font = "bold 32px Arial";
        ctx.fillStyle = "#ff6";
        ctx.fillText(gameOverText, 60, CANVAS_H/2-16);
        ctx.font = "bold 20px Arial";
        ctx.fillStyle = "#fff";
        ctx.fillText("Score: "+score, 160, CANVAS_H/2+24);
        ctx.restore();
      }

      requestAnimationFrame(gameLoop);
    }

    // ====== Spawn Soda ======
    function spawnSoda() {
      if(gameOver) return;
      let levelIdx;
      if(secretMode) {
        // Level 2 spawn
        levelIdx = LEVEL_2_START + Math.floor(Math.random()*12);
      } else {
        // Level 1 spawn
        // Orange Mountain unlock chance
        if(unlockedOrangeMountain && Math.random()<orangeMountainChance) {
          levelIdx = ORANGE_MOUNTAIN_IDX; // Orange Mountain
        } else {
          levelIdx = Math.floor(Math.random()*LEVEL_1_LEN);
        }
      }
      currentSoda = new Soda(levelIdx, currentSodaX, SPAWN_Y);
      readyToDrop = true;
      canDrop = true;
    }

    // ====== Drop Soda ======
    function dropSoda() {
      if(!readyToDrop || gameOver) return;
      readyToDrop = false;
      dropSfx.currentTime = 0; dropSfx.play();
      // Drop
      currentSoda.x = currentSodaX;
      currentSoda.y = SPAWN_Y;
      currentSoda.vx = 0;
      currentSoda.vy = 0;
      sodasInPlay.push(currentSoda);
      currentSoda = null;
      setTimeout(spawnSoda, SPAWN_INTERVAL);
    }

    // ====== Update Sodas ======
    function updateSodas() {
      if(gameOver) return;

      // Physics
      sodasInPlay.forEach(soda=> {
        if(soda.merging) return;
        // Gravity
        soda.vy += GRAVITY;
        // Move
        soda.x += soda.vx;
        soda.y += soda.vy;
        // Friction
        soda.vx *= FRICTION;
        soda.vy *= FRICTION;
        // Wall collision
        if(soda.x-soda.radius<BOX_X) { soda.x=BOX_X+soda.radius; soda.vx*=-0.7; }
        if(soda.x+soda.radius>BOX_X+BOX_W) { soda.x=BOX_X+BOX_W-soda.radius; soda.vx*=-0.7; }
        // Floor
        if(soda.y+soda.radius>BOX_Y+BOX_H) {
          soda.y = BOX_Y+BOX_H-soda.radius;
          if(Math.abs(soda.vy)>1.5) soda.vy *= -0.55;
          else soda.vy = 0;
        }
      });

      // Soda collision
      for(let i=0; i<sodasInPlay.length; ++i) {
        for(let j=i+1; j<sodasInPlay.length; ++j) {
          let a = sodasInPlay[i], b = sodasInPlay[j];
          if(a.merging||b.merging) continue;
          let dx = b.x-a.x, dy = b.y-a.y;
          let dist = Math.hypot(dx,dy), minDist = a.radius+b.radius;
          if(dist<minDist) {
            // Push apart
            let overlap = (minDist-dist)/2;
            let angle = Math.atan2(dy,dx);
            a.x -= Math.cos(angle)*overlap; a.y -= Math.sin(angle)*overlap;
            b.x += Math.cos(angle)*overlap; b.y += Math.sin(angle)*overlap;
            // Exchange velocity
            let nx = dx/dist, ny = dy/dist;
            let p = 2*(a.vx*nx + a.vy*ny - b.vx*nx - b.vy*ny)/(1+1);
            a.vx -= p*nx;
            a.vy -= p*ny;
            b.vx += p*nx;
            b.vy += p*ny;
            // Check for merging
            if(Math.abs(a.vx-b.vx)<2.8 && Math.abs(a.vy-b.vy)<2.8 && dist<minDist*0.92) {
              if(a.level===b.level && !a.fizzing && !b.fizzing) {
                mergeSodas(i,j);
                return; // Only one merge per frame
              }
            }
          }
        }
      }
    }

    // ====== Merge Sodas ======
    function mergeSodas(i,j) {
      let a = sodasInPlay[i], b = sodasInPlay[j];
      let mergeLevel = a.level;
      // Special: Orange Mountain
      let isOM = (mergeLevel===ORANGE_MOUNTAIN_IDX);
      let mergeUp = 1;
      if(isOM) mergeUp = 2;
      // Combo: Orange Mountain Unlock (Mountain Dew + Fanta)
      if(!unlockedOrangeMountain && ((a.level===7 && b.level===8)||(a.level===8 && b.level===7))) {
        unlockedOrangeMountain = true;
        orangeMountainChance = 0.266;
        orangeMountainSfx.currentTime=0; orangeMountainSfx.play();
        spawnFizz((a.x+b.x)/2, (a.y+b.y)/2, "#ff9f33", FIZZ_PARTICLES*2);
        showNotice("Orange Mountain Unlocked!");
      }
      // Combo: Soda War (Coke + Pepsi)
      if((a.level===10 && b.level===11)||(a.level===11 && b.level===10)) {
        // Remove half sodas
        for(let k=0; k<sodasInPlay.length; ++k) {
          if(Math.random()<0.5 && k!==i && k!==j) sodasInPlay[k].fizzing=true;
        }
        setTimeout(()=>{ sodasInPlay = sodasInPlay.filter(s=>!s.fizzing); }, 350);
        score += 300;
        spawnFizz((a.x+b.x)/2, (a.y+b.y)/2, "#c33", FIZZ_PARTICLES*2);
        fizzSfx.currentTime=0; fizzSfx.play();
        showNotice("SODA WAR! (+300)");
        return;
      }
      // Combo: Fizz Explosion (3 Pepsis)
      let peps = sodasInPlay.filter(s=>s.level===11 && !s.merging);
      if(peps.length>=3 && !comboFizz && !secretMode) {
        comboFizz = true;
        // Remove all sodas, spawn fizz
        sodasInPlay.forEach(s=>s.fizzing=true);
        setTimeout(()=>{ sodasInPlay = []; }, 380);
        spawnFizz(CANVAS_W/2, BOX_Y+BOX_H/2, "#fff", FIZZ_PARTICLES*3);
        fizzSfx.currentTime=0; fizzSfx.play();
        score += 400;
        setTimeout(()=>{ toSecretMode(); }, 700);
        showNotice("Fizz Explosion! Level Up!");
        return;
      }
      // Combo: Final Fizz (Game Over) - on Secret Level: merge 3 Pepsis
      if(secretMode) {
        let peps2 = sodasInPlay.filter(s=>s.level===LEVEL_2_START+6 && !s.merging);
        if(peps2.length>=3 && !comboFizz) {
          comboFizz = true;
          sodasInPlay.forEach(s=>s.fizzing=true);
          setTimeout(()=>{ sodasInPlay = []; }, 400);
          spawnFizz(CANVAS_W/2, BOX_Y+BOX_H/2, "#f7f7f7", FIZZ_PARTICLES*4);
          fizzSfx.currentTime=0; fizzSfx.play();
          setTimeout(()=>{ endGame("FINAL FIZZ!"); }, 1000);
          showNotice("Final Fizz! GAME OVER");
          return;
        }
      }

      // Regular merging
      mergeSfx.currentTime = 0; mergeSfx.play();
      a.merging = b.merging = true;
      let mx = (a.x+b.x)/2, my = (a.y+b.y)/2;
      spawnFizz(mx, my, "#fff", FIZZ_PARTICLES);
      setTimeout(()=>{
        // Remove a & b, spawn new soda at mx,my
        sodasInPlay = sodasInPlay.filter((s,idx)=>idx!==i && idx!==j);
        let nextLevel = mergeLevel+mergeUp;
        if(nextLevel < sodas.length) {
          sodasInPlay.push(new Soda(nextLevel, mx, my-20, 0, -2));
          score += 20*nextLevel;
        } else {
          // Max level, just vanish for now
          score += 30*nextLevel;
        }
        updateScore();
      }, 170);
    }

    // ====== Next Level (Secret Mode) ======
    function toSecretMode() {
      secretMode = true;
      level = 2;
      comboFizz = false;
      sodasInPlay = [];
      updateScore();
      levelSpan.textContent = level;
      setTimeout(spawnSoda, 700);
    }

    // ====== Game Over ======
    function endGame(msg) {
      gameOver = true;
      gameOverText = msg;
      canDrop = false;
      bgm.pause();
      gameoverSfx.currentTime=0; gameoverSfx.play();
      gameOverDiv.textContent = msg + " | Score: " + score;
      gameOverDiv.classList.remove('hidden');
    }

    // ====== Show Notice ======
    let noticeTimeout = null;
    function showNotice(msg) {
      gameOverDiv.textContent = msg;
      gameOverDiv.classList.remove('hidden');
      if(noticeTimeout) clearTimeout(noticeTimeout);
      noticeTimeout = setTimeout(()=>gameOverDiv.classList.add('hidden'), 1800);
    }

    // ====== Update Score/Highscore ======
    function updateScore() {
      scoreSpan.textContent = score;
      if(score>highscore) {
        highscore = score;
        localStorage.setItem('sodaHighscore', highscore);
        highscoreSpan.textContent = highscore;
      }
    }

    // ====== Render Lineup ======
    function renderLineup() {
      lineupDiv.innerHTML = "";
      let sodaList = secretMode ? sodas.slice(LEVEL_2_START, LEVEL_2_START+12) : sodas.slice(0,LEVEL_1_LEN);
      // Orange Mountain
      if(unlockedOrangeMountain && !secretMode) {
        sodaList = [...sodaList,sodas[ORANGE_MOUNTAIN_IDX]];
      }
      sodaList.forEach(s=>{
        let img = document.createElement("img");
        img.src = s.img;
        img.title = s.name;
        lineupDiv.appendChild(img);
      });
    }

    // ====== Reset Game ======
    function resetGame() {
      sodasInPlay = [];
      score = 0;
      level = 1;
      unlockedOrangeMountain = false;
      orangeMountainChance = 0;
      secretMode = false;
      fizzyParticles = [];
      gameOver = false;
      comboFizz = false;
      gameOverText = "";
      updateScore();
      levelSpan.textContent = level;
      canDrop = true;
      gameOverDiv.classList.add('hidden');
      spawnSoda();
      renderLineup();
      if(!bgmStarted) { bgmStarted = true; bgm.currentTime = 0; bgm.play(); }
      else { bgm.currentTime = 0; bgm.play(); }
    }

    // ====== Input ======
    canvas.addEventListener('mousemove', e=>{
      let rect = canvas.getBoundingClientRect();
      let mx = e.clientX - rect.left;
      mouseX = clamp(mx, BOX_X+30, BOX_X+BOX_W-30);
      if(currentSoda) currentSodaX = mouseX;
    });
    document.addEventListener('keydown', e=>{
      if(gameOver && e.code==="Space") { resetGame(); return; }
      if(!canDrop) return;
      if(e.code==="ArrowDown" || e.code==="Space") dropSoda();
      if(e.code==="KeyR") resetGame();
    });
    canvas.addEventListener('click', ()=>{
      if(gameOver) { resetGame(); return; }
      dropSoda();
    });
    resetBtn.addEventListener('click', resetGame);

    // ====== Main ======
    function main() {
      let hs = parseInt(localStorage.getItem('sodaHighscore'));
      highscore = isNaN(hs)?0:hs;
      highscoreSpan.textContent = highscore;
      spawnSoda();
      renderLineup();
      bgm.volume = 0.16;
      mergeSfx.volume = 0.5;
      dropSfx.volume = 0.4;
      orangeMountainSfx.volume = 0.5;
      fizzSfx.volume = 0.6;
      gameoverSfx.volume = 0.7;
      setInterval(()=>{
        if(!gameOver) updateSodas();
        renderLineup();
      }, 1000/60);
      gameLoop();
    }

    main();
  </script>
</body>
</html>
